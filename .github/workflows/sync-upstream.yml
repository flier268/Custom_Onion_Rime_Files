name: Sync from Upstream and Build

# è‡ªå‹•å¾ä¸Šæ¸¸åŒæ­¥æ›´æ–°ä¸¦æ‰“åŒ…
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 00:00 åŸ·è¡Œ
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼·åˆ¶æ‰“åŒ…ä¸¦ç™¼å¸ƒï¼ˆå³ä½¿æ²’æœ‰æ›´æ–°ï¼‰'
        required: false
        type: boolean
        default: false

env:
  UPSTREAM_REPO: oniondelta/Onion_Rime_Files
  UPSTREAM_BRANCH: main
  PYTHON_VERSION: '3.x'

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync with upstream
        id: sync
        run: |
          set -euo pipefail

          # æ·»åŠ ä¸Šæ¸¸é ç«¯
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git 2>/dev/null || true
          git fetch upstream

          # å˜—è©¦åˆä½µ
          BEFORE_SHA=$(git rev-parse HEAD)

          if git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit; then
            AFTER_SHA=$(git rev-parse HEAD)

            if [ "$BEFORE_SHA" = "$AFTER_SHA" ]; then
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "::notice::Already up to date with upstream"
            else
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "::notice::Successfully merged $(git log --oneline $BEFORE_SHA..$AFTER_SHA | wc -l) commits"
            fi

            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "::error::Merge conflict detected"
            git merge --abort
            exit 1
          fi

      - name: Push changes
        if: steps.sync.outputs.has_updates == 'true'
        run: git push origin ${{ github.ref_name }}

      - name: Determine if build needed
        id: check_build
        run: |
          FORCE_BUILD="${{ github.event.inputs.force_build }}"
          HAS_UPDATES="${{ steps.sync.outputs.has_updates }}"

          if [ "$HAS_UPDATES" = "true" ] || [ "$FORCE_BUILD" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "::notice::Build will be triggered"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "::notice::No build needed"
          fi

      - name: Run packaging script
        if: steps.check_build.outputs.should_build == 'true'
        id: package
        run: |
          set -euo pipefail

          echo "::group::Running sort_rime_file.py"
          python sort_rime_file.py
          echo "::endgroup::"

          # æŸ¥æ‰¾ç”Ÿæˆçš„è³‡æ–™å¤¾
          PACKAGE_DIR=$(find . -maxdepth 1 -type d -name "é›»è…¦RIMEæ–¹æ¡ˆ_*" | head -1)

          if [ -z "$PACKAGE_DIR" ]; then
            echo "::error::Package directory not found"
            exit 1
          fi

          PACKAGE_DIR=$(basename "$PACKAGE_DIR")
          VERSION=$(echo "$PACKAGE_DIR" | sed 's/é›»è…¦RIMEæ–¹æ¡ˆ_//')

          echo "package_dir=$PACKAGE_DIR" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_tag=v$VERSION" >> $GITHUB_OUTPUT

          echo "::notice::Package created: $PACKAGE_DIR"

      - name: Create release archives
        if: steps.check_build.outputs.should_build == 'true'
        run: |
          set -euo pipefail

          PACKAGE_DIR="${{ steps.package.outputs.package_dir }}"
          VERSION="${{ steps.package.outputs.version }}"
          RELEASES_DIR="releases"

          mkdir -p "$RELEASES_DIR"

          # ç²å– releases ç›®éŒ„çš„çµ•å°è·¯å¾‘
          RELEASES_DIR_ABS="$(pwd)/$RELEASES_DIR"

          # ä¸­æ–‡åˆ°è‹±æ–‡çš„æ˜ å°„å‡½æ•¸
          translate_name() {
            local chinese_name="$1"
            case "$chinese_name" in
              æ³¨éŸ³æ´‹è”¥ç´”æ³¨éŸ³ç‰ˆ_*)
                echo "Bopomofo_Onion_Pure_${chinese_name##*_}"
                ;;
              æ³¨éŸ³æ´‹è”¥plusç‰ˆ_*)
                echo "Bopomofo_Onion_Plus_${chinese_name##*_}"
                ;;
              æ³¨éŸ³æ´‹è”¥mixinç‰ˆ_*)
                echo "Bopomofo_Onion_Mixin_${chinese_name##*_}"
                ;;
              æ³¨éŸ³æ´‹è”¥mixinç‰ˆ2_*)
                echo "Bopomofo_Onion_Mixin2_${chinese_name##*_}"
                ;;
              æ³¨éŸ³æ´‹è”¥mixinç‰ˆ3_*)
                echo "Bopomofo_Onion_Mixin3_${chinese_name##*_}"
                ;;
              æ³¨éŸ³æ´‹è”¥mixinç‰ˆ4_*)
                echo "Bopomofo_Onion_Mixin4_${chinese_name##*_}"
                ;;
              æ³¨éŸ³æ´‹è”¥é›™æ‹¼ç‰ˆ_*)
                echo "Bopomofo_Onion_Shuangpin_${chinese_name##*_}"
                ;;
              åœ°çƒæ‹¼éŸ³æ´‹è”¥mix-inç‰ˆ_*)
                echo "Terra_Pinyin_Onion_Mixin_${chinese_name##*_}"
                ;;
              æ‹¼éŸ³æ´‹è”¥mixinç‰ˆ_*)
                echo "Pinyin_Onion_Mixin_${chinese_name##*_}"
                ;;
              æ´‹è”¥è¡Œåˆ—30_*)
                echo "Onion_Array30_${chinese_name##*_}"
                ;;
              æ´‹è”¥è¡Œåˆ—30ç°¡åŒ–ç‰ˆ_*)
                echo "Onion_Array30_Simplified_${chinese_name##*_}"
                ;;
              æ´‹è”¥è¡Œåˆ—10_*)
                echo "Onion_Array10_${chinese_name##*_}"
                ;;
              æ´‹è”¥è¡Œåˆ—10ç°¡åŒ–ç‰ˆ_*)
                echo "Onion_Array10_Simplified_${chinese_name##*_}"
                ;;
              æ´‹è”¥OCM_mixin_*)
                echo "Onion_OCM_Mixin_${chinese_name##*_}"
                ;;
              æ´‹è”¥OCM_*)
                echo "Onion_OCM_${chinese_name##*_}"
                ;;
              ocm_*)
                echo "OCM_${chinese_name##*_}"
                ;;
              å…¶ä»–)
                echo "Others"
                ;;
              *)
                # å¦‚æœæ²’æœ‰åŒ¹é…ï¼Œä¿ç•™åŸå
                echo "$chinese_name"
                ;;
            esac
          }

          echo "::group::Creating ZIP archives"

          # å‰µå»ºæ˜ å°„æ–‡ä»¶è¨˜éŒ„ä¸­è‹±æ–‡å°æ‡‰é—œä¿‚
          > "$RELEASES_DIR_ABS/filename_mapping.txt"

          cd "$PACKAGE_DIR"

          for schema_dir in */; do
            schema_name="${schema_dir%/}"

            # ç”Ÿæˆè‹±æ–‡æª”å
            english_name=$(translate_name "$schema_name")
            archive_name="${english_name}.zip"

            echo "Compressing: $schema_name -> $archive_name"
            (cd "$schema_name" && zip -rq9 "$RELEASES_DIR_ABS/$archive_name" .)

            # è¨˜éŒ„æ˜ å°„é—œä¿‚
            echo "$archive_name -> $schema_name" >> "$RELEASES_DIR_ABS/filename_mapping.txt"
          done

          cd ..
          echo "::endgroup::"

          echo "::group::Created archives"
          ls -lh "$RELEASES_DIR/"
          echo "::endgroup::"

          echo "::group::Filename mappings"
          cat "$RELEASES_DIR/filename_mapping.txt"
          echo "::endgroup::"

      - name: Create and Upload Release
        if: steps.check_build.outputs.should_build == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.package.outputs.version }}"
          REPO="${{ github.repository }}"
          
          echo "æº–å‚™å»ºç«‹ Release: v$VERSION"
          
          # å»ºç«‹ release
          gh release create "v$VERSION" \
            --repo "$REPO" \
            --title "Onion Rime æ–¹æ¡ˆ $VERSION" \
            --notes "## ğŸ“¦ è‡ªå‹•æ‰“åŒ…ç™¼å¸ƒ
          
          æ­¤ç‰ˆæœ¬å¾ä¸Šæ¸¸å€‰åº« [oniondelta/Onion_Rime_Files](https://github.com/oniondelta/Onion_Rime_Files) è‡ªå‹•åŒæ­¥ä¸¦æ‰“åŒ…ã€‚

          ### ğŸ“¥ ä¸‹è¼‰èªªæ˜

          è«‹æ ¹æ“šæ‚¨ä½¿ç”¨çš„è¼¸å…¥æ³•ä¸‹è¼‰å°æ‡‰çš„ ZIP æª”æ¡ˆ:
          - **æ³¨éŸ³æ´‹è”¥ç´”æ³¨éŸ³ç‰ˆ**: \`Bopomofo_Onion_Pure_*.zip\`
          - **æ³¨éŸ³æ´‹è”¥ Plus ç‰ˆ**: \`Bopomofo_Onion_Plus_*.zip\`
          - **æ³¨éŸ³æ´‹è”¥ Mixin ç‰ˆ**: \`Bopomofo_Onion_Mixin*.zip\`
          - **æ³¨éŸ³æ´‹è”¥é›™æ‹¼ç‰ˆ**: \`Bopomofo_Onion_Shuangpin_*.zip\`
          - **æ‹¼éŸ³æ´‹è”¥ Mixin ç‰ˆ**: \`Pinyin_Onion_Mixin_*.zip\`
          - **æ´‹è”¥è¡Œåˆ—30**: \`Onion_Array30*.zip\`
          - **æ´‹è”¥è¡Œåˆ—10**: \`Onion_Array10*.zip\`
          - **æ´‹è”¥OCM**: \`Onion_OCM*.zip\`

          > **æ³¨æ„**: æª”æ¡ˆæ¨™ç±¤æœƒé¡¯ç¤ºä¸­æ–‡æ–¹æ¡ˆåç¨±ï¼Œå¯¦éš›ä¸‹è¼‰çš„æª”æ¡ˆåç¨±ç‚ºè‹±æ–‡ã€‚
          
          ### ğŸ”§ å®‰è£æ–¹æ³•
          
          1. ä¸‹è¼‰å°æ‡‰çš„ ZIP æª”æ¡ˆ
          2. è§£å£“ç¸®åˆ° Rime ç”¨æˆ¶è³‡æ–™å¤¾:
            - **Linux (fcitx5)**: \`~/.local/share/fcitx5/rime/\`
            - **Linux (ibus)**: \`~/.config/ibus/rime/\`
            - **macOS (Squirrel)**: \`~/Library/Rime/\`
            - **Windows (Weasel)**: \`%APPDATA%\Rime\`
          3. é‡æ–°éƒ¨ç½² Rime
          
          ### âš ï¸ æ³¨æ„äº‹é …
          
          - è«‹å‹¿è¦†è“‹æ•´å€‹ \`opencc/\` è³‡æ–™å¤¾,åƒ…åˆä½µå…§éƒ¨æª”æ¡ˆ
          - éœ€è¦ librime â‰¥1.11.2 åŠ librime-lua â‰¥#200
          
          ---
          
          **åŒæ­¥æ™‚é–“**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          echo "é–‹å§‹ä¸Šå‚³æª”æ¡ˆ..."

          # è®€å–æ˜ å°„æ–‡ä»¶ä¸¦ä¸Šå‚³ zip æª”æ¡ˆ
          while IFS= read -r line; do
            # ä½¿ç”¨ -> åˆ†å‰²è‹±æ–‡æª”åå’Œä¸­æ–‡åç¨±
            english_filename="${line%% -> *}"
            chinese_filename="${line##* -> }"

            file="releases/$english_filename"
            if [ -f "$file" ]; then
              # ä½¿ç”¨è‹±æ–‡æª”åä½œç‚ºå¯¦éš›æª”æ¡ˆï¼Œä¸­æ–‡åç¨±ä½œç‚ºé¡¯ç¤ºæ¨™ç±¤
              echo "ä¸Šå‚³: $english_filename (é¡¯ç¤ºç‚º: $chinese_filename)"
              gh release upload "v$VERSION" "$file#$chinese_filename" --repo "$REPO" --clobber
            fi
          done < releases/filename_mapping.txt

          echo "âœ… Release å»ºç«‹å®Œæˆ!"

      - name: Create issue on failure
        if: failure() && steps.sync.outputs.merge_success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ ä¸Šæ¸¸åŒæ­¥å¤±æ•—ï¼šç™¼ç¾åˆä½µè¡çª',
              body: `## å•é¡Œæè¿°

            è‡ªå‹•åŒæ­¥ä¸Šæ¸¸ \`${{ env.UPSTREAM_REPO }}\` æ™‚ç™¼ç”Ÿåˆä½µè¡çªã€‚

            ## è©³ç´°è³‡è¨Š

            - **Workflow Run**: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **åˆ†æ”¯**: \`${context.ref}\`
            - **è§¸ç™¼æ™‚é–“**: ${new Date().toISOString()}
            - **è§¸ç™¼æ–¹å¼**: \`${context.eventName}\`

            ## æ‰‹å‹•ä¿®å¾©æ­¥é©Ÿ

            \`\`\`bash
            # 1. æ·»åŠ ä¸Šæ¸¸é ç«¯
            git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git

            # 2. æ‹‰å–ä¸Šæ¸¸æ›´æ–°
            git fetch upstream

            # 3. å˜—è©¦åˆä½µ
            git merge upstream/${{ env.UPSTREAM_BRANCH }}

            # 4. è§£æ±ºè¡çªå¾Œ
            git add .
            git commit -m "Merge upstream changes"

            # 5. æ¨é€æ›´æ–°
            git push origin ${{ env.UPSTREAM_BRANCH }}
            \`\`\`

            ## ç›¸é—œè³‡æº

            - [ä¸Šæ¸¸å€‰åº«](https://github.com/${{ env.UPSTREAM_REPO }})
            - [Git è¡çªè§£æ±ºæŒ‡å—](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/resolving-a-merge-conflict-using-the-command-line)

            ---

            _æ­¤ issue ç”± GitHub Actions è‡ªå‹•å»ºç«‹_`,
              labels: ['sync', 'conflict', 'automated']
            });

            core.notice(\`Created issue: \${issue.data.html_url}\`);

      - name: Workflow summary
        if: always()
        run: |
          {
            echo "## å·¥ä½œæµç¨‹æ‘˜è¦"
            echo ""
            echo "### åŸºæœ¬è³‡è¨Š"
            echo "- **è§¸ç™¼æ–¹å¼**: ${{ github.event_name }}"
            echo "- **åˆ†æ”¯**: ${{ github.ref_name }}"
            echo "- **åŸ·è¡Œæ™‚é–“**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""

            if [ "${{ steps.sync.outputs.merge_success }}" = "true" ]; then
              echo "### âœ… åŒæ­¥ç‹€æ…‹"
              if [ "${{ steps.sync.outputs.has_updates }}" = "true" ]; then
                echo "- æˆåŠŸåˆä½µä¸Šæ¸¸æ›´æ–°"
              else
                echo "- å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
              fi
            else
              echo "### âŒ åŒæ­¥ç‹€æ…‹"
              echo "- åˆä½µå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸Šæ–¹éŒ¯èª¤"
            fi
            echo ""

            if [ "${{ steps.check_build.outputs.should_build }}" = "true" ]; then
              echo "### ğŸ“¦ Release è³‡è¨Š"
              echo "- **ç‰ˆæœ¬**: ${{ steps.package.outputs.version }}"
              echo "- **æ¨™ç±¤**: ${{ steps.package.outputs.version_tag }}"
              echo "- **Release åç¨±**: Onion Rime æ–¹æ¡ˆ ${{ steps.package.outputs.version }}"
              echo ""
              echo "ğŸ’¡ ä¸‹è¼‰ Releaseï¼š"
              echo "[æŸ¥çœ‹ Release é é¢](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.package.outputs.version_tag }})"
            fi
          } >> $GITHUB_STEP_SUMMARY
